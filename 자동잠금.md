Docker Swarm에서 Autolock 기능을 사용하는 방법

### Autolock (자동 잠금)
Docker Swarm은 기본적으로 여러 가지 보안 기능을 제공하지만, 여전히 보안 문제가 발생할 수 있는 몇 가지 상황이 존재합니다. 예를 들어, 오래된 매니저를 다시 시작하거나 백업을 복원할 경우 클러스터의 보안이 위험해질 수 있습니다. 왜냐하면 오래된 매니저가 Swarm에 재가입할 때 자동으로 암호화된 Raft 로그 타임 시리즈 데이터베이스에 접근할 수 있기 때문입니다. 이 경우 오래된 데이터가 현재 클러스터 구성에 영향을 미칠 수 있습니다.

이와 같은 보안 문제를 방지하기 위해 Docker는 Swarm 클러스터에 잠금을 걸 수 있는 **Autolock 기능**을 제공합니다. 이 기능을 활성화하면, 재시작된 매니저가 클러스터에 다시 가입하려면 **클러스터 잠금 해제 키(unlock key)**를 제시해야 합니다. 이로 인해 오래된 매니저나 백업 데이터가 자동으로 Swarm 클러스터에 접근하는 것을 방지할 수 있습니다.

#### Autolock 활성화
새로운 Swarm을 만들 때 `docker swarm init` 명령어에 `--autolock` 플래그를 추가하여 Autolock을 활성화할 수 있습니다. 그러나 이미 구축된 Swarm 클러스터라면, `docker swarm update` 명령어를 사용하여 Autolock을 설정할 수 있습니다.

```bash
docker swarm update --autolock
```

이 명령어를 실행하면 Swarm이 잠기고, 매니저가 재시작될 때 잠금 해제 키를 입력해야 클러스터에 다시 접속할 수 있게 됩니다.

### Unlocking (잠금 해제)
Autolock을 설정한 후, **잠금 해제 키를 안전한 장소에 보관**해야 합니다. 잠금 해제 키를 분실하면 클러스터에 다시 접근하는 것이 어려워질 수 있습니다. 현재 Swarm의 잠금 해제 키를 확인하려면 `docker swarm unlock-key` 명령어를 사용할 수 있습니다.

```bash
docker swarm unlock-key
```

#### 매니저 노드 재시작 및 잠금 해제
Autolock이 활성화된 상태에서 매니저 노드를 재시작하면, 이 매니저는 잠금 해제 키를 입력하지 않는 이상 클러스터에 자동으로 재가입되지 않습니다. 이를 확인하기 위해 매니저 노드 중 하나를 재시작하고 `docker node ls` 명령어를 다른 매니저 노드에서 실행하면, 재시작된 매니저가 **다운(Down)** 상태로 표시되며 접근 불가능한 상태로 나타납니다.

만약 Linux 플랫폼에서 `service docker restart` 명령어가 지원되지 않는 경우, `ps aux` 명령어로 `dockerd`의 PID를 확인한 후 `kill -HUP [PID]` 명령을 실행하여 재시작할 수 있습니다.

```bash
# Dockerd PID 확인
ps aux | grep dockerd

# dockerd 재시작
kill -HUP [PID]
```

#### 매니저 노드에 대한 잠금 해제
재시작된 매니저가 다시 클러스터에 접속할 수 있도록 하려면 `docker swarm unlock` 명령어를 실행하여 잠금을 해제해야 합니다. 이 명령어를 재시작된 매니저 노드에서 실행하고 잠금 해제 키를 입력해야 합니다.

```bash
docker swarm unlock
```

잠금 해제가 완료되면 `docker node ls` 명령어로 노드 상태를 확인했을 때, 해당 매니저가 **준비 완료(Ready)** 및 **접근 가능(Reachable)** 상태로 표시됩니다.

### Autolock 기능의 중요성
생산 환경에서 Swarm 클러스터를 잠그고 잠금 해제 키를 보호하는 것은 보안을 강화하는 데 필수적입니다. Autolock을 활성화하면 오래된 매니저나 백업으로 인해 발생할 수 있는 보안 위험을 최소화할 수 있으며, 외부에서 클러스터에 무단 접근하는 것을 방지할 수 있습니다.

이제 Swarm의 매니저 노드 고가용성, 리더와 팔로워 구조에 대한 이해를 바탕으로 다음 단계로 애플리케이션의 서비스 배포 및 관리와 같은 실질적인 작업을 진행할 수 있습니다.
