1. TLS 및 상호 인증 (Mutual Authentication in Docker Swarm)
2. 인증 기관(CA) 설정 및 클러스터 스토어 (Configuring CA Settings and the Cluster Store)
3. 이미지 보안 스캐닝 (Image Security Scanning)
4. Docker Content Trust (DCT)
5. Docker Secrets

---

### 1. TLS 및 상호 인증 (Mutual Authentication in Docker Swarm)
**TLS**(Transport Layer Security)는 Docker Swarm의 보안을 보장하기 위해 사용되는 암호화 프로토콜입니다. Swarm 모드에서 각 **매니저 및 워커 노드는 클라이언트 인증서를 발급**받아 **서로 상호 인증**을 수행하게 됩니다. 이를 통해 노드 간 통신의 **무결성**과 **보안성**을 확보합니다.

- **클라이언트 인증서**: Docker Swarm에서 노드가 Swarm에 가입하면 자동으로 인증서가 발급됩니다. 이 인증서에는 스웜 ID, 노드의 역할(매니저 또는 워커), 노드의 고유 ID가 포함됩니다.
- **명령어 예시**: 다음 명령어로 노드의 클라이언트 인증서를 확인할 수 있습니다.
  ```bash
  sudo openssl x509 -in /var/lib/docker/swarm/certificates/swarm-node.crt -text
  ```
  - 이 명령어를 통해 인증서의 **발행자(Issuer)**, **유효 기간(Validity)**, **주체(Subject)** 등을 확인할 수 있습니다.

Docker Swarm의 노드들은 상호 인증을 통해 **안전하게 클러스터에 참여**하며, **CA 설정**에 따라 인증서가 주기적으로 갱신됩니다.

### 2. 인증 기관(CA) 설정 및 클러스터 스토어 (Configuring CA Settings and the Cluster Store)
**CA 설정**과 **클러스터 스토어**는 Docker Swarm의 보안성과 상태 관리를 유지하는 핵심 요소들입니다.

- **CA 설정**: Docker Swarm의 **인증서 갱신 주기**를 설정할 수 있으며, 새로운 Swarm을 만들 때 **외부 CA**를 사용할 수 있습니다.
  - **인증서 갱신 주기 설정**: 예를 들어, 인증서의 갱신 주기를 30일로 설정하려면 다음과 같은 명령어를 사용합니다.
    ```bash
    docker swarm update --cert-expiry 720h
    ```
  - **외부 CA 설정**: Swarm 생성 시 `--external-ca` 플래그를 사용하여 외부 인증 기관을 지정할 수 있습니다.
  - **CA 관리 명령어**: `docker swarm ca` 명령어를 사용하여 루트 CA 인증서와 관련된 설정을 관리할 수 있습니다.

- **클러스터 스토어**: Swarm 내 모든 설정과 상태 정보가 저장되는 공간으로, 모든 매니저 노드에 **자동으로 복제**되며 기본적으로 **암호화**되어 있습니다.
  - **etcd 기반**: 클러스터 스토어는 **etcd**와 같은 분산 데이터베이스를 기반으로 하며, 신뢰성과 확장성을 제공합니다.
  - 클러스터 스토어는 네트워크와 서비스의 중요한 상태를 저장하므로 **백업과 복구**가 매우 중요합니다.

### 3. 이미지 보안 스캐닝 (Image Security Scanning)
컨테이너 이미지의 **보안 취약점**을 탐지하기 위해 **이미지 스캐너**를 사용합니다. 이미지 스캐너는 이미지에 포함된 **패키지 중에 알려진 취약점**이 있는지 검사하여 이를 보고합니다.

- **이미지 스캐너**는 이미지의 **패키지 목록**을 확인하고 **알려진 취약점 데이터베이스**와 비교하여 위험 요소를 파악합니다.
- **한계**: 이미지 스캐너는 컨테이너 이미지 내의 패키지에만 초점을 맞추며, 네트워크나 노드, 오케스트레이터의 보안 문제는 탐지하지 못합니다. 또한, 모든 이미지 스캐너가 동일한 성능을 제공하는 것은 아니므로, 어떤 스캐너를 사용할 것인지 신중히 선택해야 합니다.
- **Docker Hub**는 작성 당시 이미지 스캐닝 기능을 제공하지 않으며, 일부 프라이빗 레지스트리나 서드파티 서비스는 이러한 기능을 제공하고 있습니다.

이미지 보안 스캐닝을 통해 **알려진 취약점을 미리 파악**하고, 패키지 업데이트 등을 통해 이를 해결할 수 있습니다.

### 4. Docker Content Trust (DCT)
**Docker Content Trust (DCT)**는 컨테이너 이미지를 **다운로드하거나 실행할 때 해당 이미지의 무결성과 발행자**를 확인하는 기능입니다. 이를 통해 **안전한 이미지 사용**을 보장합니다.

- **개요**: DCT는 이미지가 Docker Hub 또는 기타 컨테이너 레지스트리에 푸시될 때 **개발자가 이미지를 서명**하게 하고, 이 서명된 이미지를 사용자들이 다운로드할 때 **무결성을 확인**할 수 있도록 합니다.
- **서명 및 검증**: 이미지를 **서명(sign)**하고 **Docker Hub**와 같은 저장소에 **푸시**하면, 해당 이미지는 서명된 상태로 저장됩니다. 사용자는 이를 **검증**한 후 안전하게 이미지를 사용할 수 있습니다.
- **명령어 예시**:
  - **키 쌍 생성**: 이미지를 서명하려면 다음 명령어를 통해 암호화 키 쌍을 생성합니다.
    ```bash
    docker trust key generate nigel
    ```
  - **이미지 서명 및 푸시**: 서명된 이미지를 푸시하려면 다음과 같은 명령어를 사용합니다.
    ```bash
    docker trust sign nigelpoulton/dct:signed
    ```
- **DCT 활성화**: DCT를 강제하려면 `DOCKER_CONTENT_TRUST` 환경 변수를 설정합니다.
  ```bash
  export DOCKER_CONTENT_TRUST=1
  ```
  이를 통해 서명되지 않은 이미지는 사용하지 않도록 강제할 수 있습니다.

### 5. Docker Secrets
**Docker Secrets**는 애플리케이션이 필요한 비밀 정보(예: 비밀번호, TLS 인증서, SSH 키)를 **안전하게 관리**하고 사용하도록 해주는 기능입니다. Docker Secrets는 특히 민감한 데이터의 안전한 전달과 저장을 보장합니다.

- **배경**: Docker의 초기 버전에서는 비밀 정보를 안전하게 전달할 표준적인 방법이 없었으며, 환경 변수에 평문으로 데이터를 넣는 방식이 주로 사용되었습니다. 이는 매우 위험한 방식이었습니다. **Docker 1.13**부터 Docker Secrets가 도입되어 민감한 정보를 안전하게 관리할 수 있게 되었습니다.
- **내부 동작 방식**:
  - **비밀 정보는 암호화된 상태로 저장 및 전송**됩니다.
  - 컨테이너 내부에서는 비밀 정보가 **인메모리 파일시스템(tmpfs)**에 마운트되며, 디스크에 기록되지 않고 메모리상에만 존재합니다.
  - 특정 서비스에만 명시적으로 **접근 권한이 부여**된 경우에만 해당 비밀 정보를 사용할 수 있습니다.
- **워크플로우**:
  - **비밀 정보 생성 및 Swarm 등록**: `docker secret` 명령어를 사용하여 비밀 정보를 생성하고 Swarm에 등록합니다.
  - **서비스에 비밀 정보 연결**: 생성된 비밀 정보는 특정 서비스에 연결되어 해당 서비스의 컨테이너에서만 접근할 수 있습니다.
  - **비밀 정보 마운트**: 컨테이너 내부에서는 비밀 정보가 `/run/secrets/` 디렉토리에 마운트되며, 이는 메모리상에만 존재하므로 보안성이 높습니다.
  - **컨테이너 종료 시 비밀 정보 삭제**: 컨테이너 작업이 완료되면, 인메모리 파일시스템이 해체되고 비밀 정보는 노드에서 완전히 삭제됩니다.
- **명령어 예시**:
  ```bash
  # 비밀 정보 생성
  echo "mysecret" | docker secret create my_secret -

  # 서비스 생성 시 비밀 정보 연결
  docker service create --name my_service --secret my_secret nginx
  ```

Docker Secrets는 애플리케이션이 민감한 정보를 안전하게 사용하도록 해주는 중요한 도구로, 이를 통해 보안성을 유지하며 데이터 보호를 강화할 수 있습니다.

---

### 요약
지금까지 다룬 Docker와 관련된 보안 기능들은 모두 컨테이너 환경에서 **보안성을 강화**하고, **민감한 데이터를 안전하게 관리**하는 것을 목표로 하고 있습니다.

1. **TLS 및 상호 인증**을 통해 Docker Swarm의 노드 간 안전한 통신을 보장합니다.
2. **인증 기관(CA) 설정**과 **클러스터 스토어**를 통해 인증서 관리와 클러스터 상태 저장을 안전하게 수행합니다.
3. **이미지 보안 스캐닝**은 컨테이너 이미지에 포함된 패키지의 보안 취약점을 탐지하고, 이를 사전에 대응할 수 있게 합니다.
4. **Docker Content Trust (DCT)**를 사용하면 이미지를 서명하고 검증하여, 안전한 이미지만 사용하도록 할 수 있습니다.
5. **Docker Secrets**는 민감한 정보를 안전하게 컨테이너에 전달하고 사용할 수 있도록 지원합니다.

Docker의 이러한 보안 기능들을 이해하고 활용하면, **보안성이 강화된 컨테이너 환경**을 구축할 수 있으며, 민감한 데이터를 안전하게 보호하면서 애플리케이션을 운영할 수 있습니다.